<script>
    function calcularCantidadDePaginas() {
            const alturaMaximaPorPagina = 232; // Altura máxima permitida por página en pt
            const seccionesTabla = document.querySelectorAll('#content .table-section');
            let alturaTotalSecciones = 0;

            // Sumar la altura de todas las secciones de la tabla
            seccionesTabla.forEach(seccion => {
                alturaTotalSecciones += seccion.scrollHeight;
            });

            // Convertir la altura de px a pt
            const alturaTotalSeccionesPt = alturaTotalSecciones / 1.333;

            // Calcular la cantidad de páginas necesarias
            const cantidadDePaginas = Math.ceil(alturaTotalSeccionesPt / alturaMaximaPorPagina);
            console.log(cantidadDePaginas);
            return cantidadDePaginas;
        }

        function actualizarIds(elemento, sufijo) {
    if (elemento.id) {
        elemento.id = `${elemento.id}-${sufijo}`;
    }
    elemento.querySelectorAll('*[id]').forEach((el) => {
        el.id = `${el.id}-${sufijo}`;
    });
}

function dividirContenidoEnPaginas() {
    let cantidadDePaginas = calcularCantidadDePaginas();
    let contenedorOriginal = document.getElementById('form-container');
    let seccionesTabla = Array.from(document.querySelectorAll('#content .table-section'));
    let paginas = [];
    let paginaActual = contenedorOriginal;
    let nuevaPagina;

    // Clonar la página original y preparar las páginas adicionales
    for (let i = 1; i < cantidadDePaginas; i++) {
        nuevaPagina = contenedorOriginal.cloneNode(true);
        actualizarIds(nuevaPagina, i);
        nuevaPagina.querySelector('#content').innerHTML = '';
        paginas.push(nuevaPagina);
    }

    // Distribuir secciones entre las páginas
    seccionesTabla.forEach((seccion, indiceSeccion) => {
        let alturaSeccion = seccion.scrollHeight / 1.333; // Convertir la altura de px a pt

        if (paginaActual.scrollHeight + alturaSeccion > alturaMaximaPorPagina) {
            // Agregar la página actual a la lista de páginas
            paginas.unshift(paginaActual);
            
            // Crear una nueva página para el contenido adicional
            nuevaPagina = contenedorOriginal.cloneNode(true);
            actualizarIds(nuevaPagina, paginas.length);
            nuevaPagina.querySelector('#content').innerHTML = '';
            paginaActual = nuevaPagina;
        }

        // Actualizar los IDs de la sección y sus hijos antes de moverlos
        let clonSeccion = seccion.cloneNode(true);
        actualizarIds(clonSeccion, paginas.length + 1);
        
        // Mover la sección a la nueva página
        paginaActual.querySelector('#content').appendChild(clonSeccion);
    });

    // Agregar la última página procesada a la lista de páginas
    if (paginaActual !== contenedorOriginal) {
        paginas.unshift(paginaActual);
    }

    // Añadir nuevas páginas al DOM y remover el contenido original
    paginas.reverse().forEach((pagina, index) => {
        if (index > 0) { // Evitar agregar la página original ya que ya está en el DOM
            document.body.appendChild(pagina);
        }
    });

    // Eliminar el contenedor original si se crearon nuevas páginas
    if (paginas.length > 1) {
        contenedorOriginal.remove();
    }
}


    function clonarConEstilos(elemento) {
        let clon = elemento.cloneNode(true);
        clon.style.cssText = elemento.style.cssText; // Copia estilos en línea
        return clon;
    }
    function cargarDatosEspecificacion(id) {
        $.ajax({
            url: './backend/calidad/documento_especificacion_productoBE.php',
            type: 'GET',
            data: { id: id },
            success: function (response) {
                procesarDatosEspecificacion(response);

            },
            error: function (xhr, status, error) {
                console.error("Error en la solicitud: ", status, error);
            }
        });
    }

    // Cargar datos y procesarlos
    function cargarDatosEspecificacion(id) {
        $.ajax({
            url: './backend/calidad/documento_especificacion_productoBE.php',
            type: 'GET',
            data: { id: id },
            success: procesarDatosEspecificacion,
            error: function(xhr, status, error) {
                console.error("Error en la solicitud: ", status, error);
            }
        });
    }

    // Procesa los datos recibidos del backend
    function procesarDatosEspecificacion(response) {
        // Asegúrate de que la respuesta es válida
        if (!response || !response.productos || !Array.isArray(response.productos)) {
            console.error('Los datos recibidos no son válidos:', response);
            return;
        }
        // Procesa y muestra los datos
        response.productos.forEach(poblarYDeshabilitarCamposProducto);
        dividirContenidoEnPaginas();
    }

    function poblarYDeshabilitarCamposProducto(producto) {
                if (producto) {
                    // Usando .text() para elementos h2, h3 y p
                    $('#Tipo_Producto').text('Especificación ' + producto.tipo_producto);
                    $('#producto').text(producto.nombre_producto);
                    $('#concentracion').text(producto.concentracion);
                    $('#formato').text(producto.formato);
                    $('#documento').text(producto.documento_producto);
                    $('#elaboradoPor').text(producto.elaborado_por);

                    let especificacion = Object.values(producto.especificaciones)[0];
                    if (especificacion) {
                        $('#fechaEdicion').text(especificacion.fecha_edicion);
                        $('#version').text(especificacion.version);
                        $('#periodosVigencia').text(especificacion.vigencia);
                        $('#creadoPor').text(especificacion.creado_por || 'No disponible');
                        $('#revisadoPor').text(especificacion.revisado_por || 'No disponible');
                        $('#aprobadoPor').text(especificacion.aprobado_por || 'No disponible');

                        // Actualizar fechas de revisión y aprobación
                        $('#fecha_Edicion').text('Fecha: ' + (especificacion.fecha_revision || 'No disponible'));
                        $('#fechaRevision').text('Fecha: ' + (especificacion.fecha_revision || 'No disponible'));
                        $('#fechaAprobacion').text('Fecha: ' + (especificacion.fecha_aprobacion || 'No disponible'));

                    }
                }
            }

            function mostrarAnalisisFQ(analisis) {
                // Verifica si hay datos para el análisis FQ
                if (analisis.length > 0) {
                    // Si hay datos, muestra la tabla y procesa los datos
                    if ($.fn.DataTable.isDataTable('#analisisFQ')) {
                        $('#analisisFQ').DataTable().clear().rows.add(analisis).draw();
                    } else {
                        $('#analisisFQ').DataTable({
                            data: analisis,
                            columns: [
                                { title: 'Análisis', data: 'descripcion_analisis' },
                                { title: 'Metodología', data: 'metodologia' },
                                { title: 'Criterio aceptación', data: 'criterios_aceptacion' }
                            ],
                            paging: false,
                            info: false,
                            searching: false,
                            lengthChange: false,
                            language: {
                                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json',
                            }
                        });
                    }
                    // Muestra la sección del análisis FQ
                    $('#content').show();
                } else {
                    // Si no hay datos, oculta la sección del análisis FQ
                    $('#content').hide();
                }
            }
            function mostrarAnalisisMB(analisis) {
                // Verifica si hay datos para el análisis microbiológico
                if (analisis.length > 0) {
                    // Si hay datos, muestra la tabla y procesa los datos
                    if ($.fn.DataTable.isDataTable('#analisisMB')) {
                        $('#analisisMB').DataTable().clear().rows.add(analisis).draw();
                    } else {
                        $('#analisisMB').DataTable({
                            data: analisis,
                            columns: [
                                { title: 'Análisis', data: 'descripcion_analisis' },
                                { title: 'Metodología', data: 'metodologia' },
                                { title: 'Criterio aceptación', data: 'criterios_aceptacion' }
                            ],
                            paging: false,
                            info: false,
                            searching: false,
                            lengthChange: false,
                            language: {
                                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json',
                            }
                        });
                    }
                    // Muestra la sección del análisis microbiológico
                    $('#additionalContent').show();
                } else {
                    // Si no hay datos, oculta la sección del análisis microbiológico
                    $('#additionalContent').hide();
                }
            }
    // Carga los datos cuando la página está lista
    window.onload = function() {
        cargarDatosEspecificacion(id); // Reemplaza con el ID real
    };
</script>
