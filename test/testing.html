<script>
    // Utilidades
    function clonarConEstilos(elemento) {
                let clon = elemento.cloneNode(true);
                clon.style.cssText = elemento.style.cssText; // Copia estilos en línea
                return clon;
            }

    // Calcula la cantidad de páginas basada en la altura de las secciones
    function calcularCantidadDePaginas() {
                const alturaMaximaPorPagina = 232; // Altura máxima permitida por página en pt
                const seccionesTabla = document.querySelectorAll('#content .table-section');
                let alturaTotalSecciones = 0;

                // Sumar la altura de todas las secciones de la tabla
                seccionesTabla.forEach(seccion => {
                    alturaTotalSecciones += seccion.scrollHeight;
                });

                // Convertir la altura de px a pt
                const alturaTotalSeccionesPt = alturaTotalSecciones / 1.333;

                // Calcular la cantidad de páginas necesarias
                const cantidadDePaginas = Math.ceil(alturaTotalSeccionesPt / alturaMaximaPorPagina);

                return cantidadDePaginas;
            }
    function dividirContenidoEnPaginas() {
                let cantidadDePaginas = calcularCantidadDePaginas();
                let contenedorOriginal = document.getElementById('form-container');
                let seccionesTabla = document.querySelectorAll('#content .table-section');
                let headerOriginal = document.querySelector('.header-container');
                let footerOriginal = document.querySelector('.footer');

                // Remueve el contenido de secciones de tabla del contenedor original para evitar duplicados
                let contenidoOriginal = contenedorOriginal.querySelector('#content');
                contenidoOriginal.innerHTML = '';

                // Clonar y reinsertar secciones de tabla en la página original si es necesario
                seccionesTabla.forEach(seccion => contenidoOriginal.appendChild(seccion.cloneNode(true)));

                let alturaMaximaPorPagina = 232; // Altura máxima permitida por página en puntos
                let alturaPaginaActual = 0;

                for (let i = 1; i < cantidadDePaginas; i++) {
                    let nuevaPagina = contenedorOriginal.cloneNode(true); // Clona el contenedor original
                    nuevaPagina.id = 'form-container-' + i;
                    nuevaPagina.style.cssText = contenedorOriginal.style.cssText;

                    // Clonar y añadir el encabezado y pie de página
                    let clonHeader = headerOriginal.cloneNode(true);
                    let clonFooter = footerOriginal.cloneNode(true);
                    nuevaPagina.insertBefore(clonHeader, nuevaPagina.firstChild); // Añade el encabezado clonado al principio
                    nuevaPagina.appendChild(clonFooter); // Añade el pie de página clonado al final

                    let nuevoContenido = nuevaPagina.querySelector('#content');
                    nuevoContenido.innerHTML = ''; // Limpia el contenido actual para la nueva página

                    while (seccionesTabla.length > 0 && alturaPaginaActual < alturaMaximaPorPagina) {
                        let alturaSeccion = seccionesTabla[0].scrollHeight / 1.333; // Convertir la altura de la sección a puntos

                        if (alturaPaginaActual + alturaSeccion <= alturaMaximaPorPagina) {
                            alturaPaginaActual += alturaSeccion;
                            // Mueve la sección al nuevo contenedor de contenido
                            nuevoContenido.appendChild(seccionesTabla[0]);
                        } else {
                            // Si la sección actual no cabe, rompe el bucle para comenzar una nueva página
                            break;
                        }
                    }

                    // Añadir la nueva página al DOM
                    document.body.appendChild(nuevaPagina);

                    // Resetea la altura de la página actual para la siguiente iteración
                    alturaPaginaActual = 0;
                }
            }

    // Cargar datos y procesarlos
    function cargarDatosEspecificacion(id) {
        $.ajax({
            url: './backend/calidad/documento_especificacion_productoBE.php',
            type: 'GET',
            data: { id: id },
            success: procesarDatosEspecificacion,
            error: function(xhr, status, error) {
                console.error("Error en la solicitud: ", status, error);
            }
        });
    }

    // Procesa los datos recibidos del backend
    function procesarDatosEspecificacion(response) {
        // Asegúrate de que la respuesta es válida
        if (!response || !response.productos || !Array.isArray(response.productos)) {
            console.error('Los datos recibidos no son válidos:', response);
            return;
        }
        // Procesa y muestra los datos
        response.productos.forEach(poblarYDeshabilitarCamposProducto);
        dividirContenidoEnPaginas();
    }

    function poblarYDeshabilitarCamposProducto(producto) {
                if (producto) {
                    // Usando .text() para elementos h2, h3 y p
                    $('#Tipo_Producto').text('Especificación ' + producto.tipo_producto);
                    $('#producto').text(producto.nombre_producto);
                    $('#concentracion').text(producto.concentracion);
                    $('#formato').text(producto.formato);
                    $('#documento').text(producto.documento_producto);
                    $('#elaboradoPor').text(producto.elaborado_por);

                    let especificacion = Object.values(producto.especificaciones)[0];
                    if (especificacion) {
                        $('#fechaEdicion').text(especificacion.fecha_edicion);
                        $('#version').text(especificacion.version);
                        $('#periodosVigencia').text(especificacion.vigencia);
                        $('#creadoPor').text(especificacion.creado_por || 'No disponible');
                        $('#revisadoPor').text(especificacion.revisado_por || 'No disponible');
                        $('#aprobadoPor').text(especificacion.aprobado_por || 'No disponible');

                        // Actualizar fechas de revisión y aprobación
                        $('#fecha_Edicion').text('Fecha: ' + (especificacion.fecha_revision || 'No disponible'));
                        $('#fechaRevision').text('Fecha: ' + (especificacion.fecha_revision || 'No disponible'));
                        $('#fechaAprobacion').text('Fecha: ' + (especificacion.fecha_aprobacion || 'No disponible'));

                    }
                }
            }

            function mostrarAnalisisFQ(analisis) {
                // Verifica si hay datos para el análisis FQ
                if (analisis.length > 0) {
                    // Si hay datos, muestra la tabla y procesa los datos
                    if ($.fn.DataTable.isDataTable('#analisisFQ')) {
                        $('#analisisFQ').DataTable().clear().rows.add(analisis).draw();
                    } else {
                        $('#analisisFQ').DataTable({
                            data: analisis,
                            columns: [
                                { title: 'Análisis', data: 'descripcion_analisis' },
                                { title: 'Metodología', data: 'metodologia' },
                                { title: 'Criterio aceptación', data: 'criterios_aceptacion' }
                            ],
                            paging: false,
                            info: false,
                            searching: false,
                            lengthChange: false,
                            language: {
                                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json',
                            }
                        });
                    }
                    // Muestra la sección del análisis FQ
                    $('#content').show();
                } else {
                    // Si no hay datos, oculta la sección del análisis FQ
                    $('#content').hide();
                }
            }
            function mostrarAnalisisMB(analisis) {
                // Verifica si hay datos para el análisis microbiológico
                if (analisis.length > 0) {
                    // Si hay datos, muestra la tabla y procesa los datos
                    if ($.fn.DataTable.isDataTable('#analisisMB')) {
                        $('#analisisMB').DataTable().clear().rows.add(analisis).draw();
                    } else {
                        $('#analisisMB').DataTable({
                            data: analisis,
                            columns: [
                                { title: 'Análisis', data: 'descripcion_analisis' },
                                { title: 'Metodología', data: 'metodologia' },
                                { title: 'Criterio aceptación', data: 'criterios_aceptacion' }
                            ],
                            paging: false,
                            info: false,
                            searching: false,
                            lengthChange: false,
                            language: {
                                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json',
                            }
                        });
                    }
                    // Muestra la sección del análisis microbiológico
                    $('#additionalContent').show();
                } else {
                    // Si no hay datos, oculta la sección del análisis microbiológico
                    $('#additionalContent').hide();
                }
            }
    // Carga los datos cuando la página está lista
    window.onload = function() {
        cargarDatosEspecificacion(id); // Reemplaza con el ID real
    };
</script>
