name: Espejo a Producción y Despliegue en Desarrollo

on:
  push:
    branches:
      - main

jobs:
  mirror-to-production:
    runs-on: ubuntu-latest
    steps:
      - name: Chequear código fuente
        uses: actions/checkout@v2
        with:
          fetch-depth: '0' # Importante para asegurar que se obtiene todo el historial

      - name: Configurar SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Clonar y preparar el repositorio productivo
        run: |
          git clone --single-branch --branch main git@github.com:Hatt3rPi/reccius.git temp_dir
          cd temp_dir
          rm -f .github/workflows/deploy-to-production.yml
          find . -type f ! -name "*.png" ! -name "*.jpg" -exec sed -i 's|https://customware.cl/reccius|https://reccius.cl/recciuscl|g' {} +
          find . -type f ! -name "*.png" ! -name "*.jpg" -exec sed -i 's|/home/customw2|/home/recciusc|g' {} +
          git config --global user.email "fabarca212@gmail.com"
          git config --global user.name "Hatt3rPi"
          git add .
          git commit -m "Actualizar el repositorio productivo"
          git remote add production git@github.com:Hatt3rPi/recciuscl.git
          git push production main --force

  deploy-to-development:
    needs: mirror-to-production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.1.0
        with:
          fetch-depth: 0
      - name: FTP-Deploy-Action
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ftp.customware.cl
          username: git_controller@customware.cl 
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          passive: true

      